#! /usr/bin/perl

use strict;
use Data::Dumper;
use lib "/home/avi/bin/Net-OnApp-Tools/lib";
use lib "/home/avi/bin/Net-OnApp/lib";
use Net::OnApp::Tools;
use Net::OnApp;

my $regex = $ARGV[0];

my ($email, $key)= getOnAppCredentials();
my $onAppURL = apiUrl();

my $onapp = Net::OnApp->new(
	api_email => $email,
	api_key	  => $key,
	api_url   => $onAppURL,
);

my $m = $onapp->getVMs;
my %machines = %{ $m };
my @rows;
$rows[0] = [qw/ID Hostname Label IP Template Booted HV/];
foreach( keys(%machines) ){
		my %m = %{ $machines{$_} };
		my @ipAddresses;
		foreach( @{ $m{'ip_addresses'} } ){
			push(@ipAddresses, $_->{'ip_address'}{'address'});
		}
		my $host     = $m{'hostname'};
		$host =~ /([^\.]+)\./;
		$host = $1;
		my $label    = $m{'label'};
		my $id       = $m{'id'};
		my $template = $m{'template_label'};
		my $boot   =  $m{'booted'};
#		my $boot     = JSON::XS::is_bool($boot);
		my $HV   = $m{'hypervisor_id'};
		if ($host =~ /$regex/i || $label =~/$regex/i){
			my @row = ($id, $host, $label, $ipAddresses[0], $template, $boot, $HV);
			push(@rows, \@row);
		}
}
tabulate(@rows);
